<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Page</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/8132c83a04.js" crossorigin="anonymous"></script>
    <!-- modal -->
    <link href="//cdn.jsdelivr.net/npm/@sweetalert2/theme-material-ui/material-ui.css" rel="stylesheet">
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
    <!-- css -->
    <link rel="stylesheet" href="/public/css/boardDetail.css" /> 
</head>
<body>
  <div class="container">

        <div class="mypage-head"> 😋 <%=detailData[0].study_name%> 에 오신걸 환영합니다! 😋
            <button type="button" onclick="goHome()" class="homeBtn">
                <i class="fa-solid fa-house"></i>
            </button>
        </div>

        <div class="menu">
            <div onclick="goSearch()">
                <i class="fa-solid fa-user">&nbsp;&nbsp;
                    <a href="http://localhost:8000/feed/board?study_id=<%=detailData[0].study_id%>">게시판조회</a>
                </i>
                <span><i class="fa-solid fa-user">&nbsp;&nbsp;
                    <a href="http://localhost:8000/feed/board?study_id=<%=detailData[0].study_id%>">게시판조회</a>
                </i></span>
            </div>
            <div onclick="goPosting()">
                <i class="fa-solid fa-podcast">&nbsp;&nbsp;
                    <a href="http://localhost:8000/feed/board/write">게시판등록</a>
                </i>
                <span><i class="fa-solid fa-podcast">&nbsp;&nbsp;
                    <a href="http://localhost:8000/feed/board/write">게시판등록</a>
                </i></span>
            </div>
        </div>

        <div class="modify-list">
/*여기부터*/
            <div class="board_list">
                <form id="comment_info">
                    <input type="text" name="studymem_name" value="<%=currentUser%>" readonly>
                    <input type="text" name="studymem_lounge_id" value="<%=detailData[0].real_lounge%>" readonly>
                    <input type="text" type="hidden" name="studymem_user_name" value="<%=detailData[0].realUser_id%>">
                    <input type="text" id="studymem_comment" name="studymem_comment">
                    <button type="button" onclick="enterComment();">등록</button>
                    <!-- 댓글 수정삭제 시간상 가능하면 하기 -->
                </form>
                <form id="board_info">
                    <div class="info-field">
                        <div class="lounge_back" onclick="backToLounge();">목록</div>
                        <table border="1" class="lounge_main" style="text-align: center;">
                            <thead>
                            <tr class="lounge_main_total">
                                <th class="lounge_main_name">작성자</th>
                                <th class="lounge_main_title">제목</th>
                                <th class="lounge_main_date">등록일</th>
                            </tr>
                            </thead>
                            <tbody>
                                <tr id="tr_<%=detailData[0].real_rounge%>" class="lounge_total">
                                    <td style="display: none;"><%=detailData[0].real_lounge%></td>
                                    <td class="lounge_name"><%=detailData[0].realUser_id%></td>
                                    <td class="lounge_title" id="<%=detailData[0].real_rounge%>"><%=detailData[0].title%></td>
                                    <td class="lounge_date"><%=detailData[0].lounge_regdate%></td>
                                </tr>
                                <tr>
                                    <td colspan="3"><%=detailData[0].lounge_contents%></td>
                                </tr>
                                <tr>
                                    <td colspan="3"><button class='deletePosting' type='button' id="<%=detailData[0].realUser_id%>" onclick="deletePost(this.id,this)">삭제</button></td>
                                </tr>
                        </tbody>
                        </table>
 
                        <div>댓글창
                            <table id="commentHere" border="1" >
                                <% for (i=0; i<detailData.length; i++) { %>
                                <tr id="tr_<%=detailData[i].reply_id%>">
                                    <td style="display: none;" class="hidden_replyId"><%=detailData[i].user_id%></td>
                                    <td class="replyName"><%=replynames[i]%></td>
                                    <td><%=detailData[i].reply_contents%></td>
                                    <td><%=detailData[i].reply_regdate%></td>
                                    <td><button class="deleteComment" id="<%=detailData[i].reply_id%>" type='button' onclick="deleteComment(this.id,this);">삭제</button></td>
                                </tr>
                                <% } %>
                            </table>
/*여기까지*/
            <form id="board_info">
            <div class="card">
                <div class="top">
                    <div class="userDetails">
                        <div class="profile-img">
                            <img src="/public/image/cat.png" class="cover">
/*여기부터*/
                        </div>
                        <h3><%=detailData[0].write_name%><br><span><%=detailData[0].lounge_regdate%></span></h3>
                    </div>
                    <div><i class="fa-solid fa-ellipsis-vertical" id="dot"></i>
                    </div>
                </div>

                <div class="messageBox">
                    <h3><%=detailData[0].title%></h3><br>
                    <h4><%=detailData[0].lounge_contents%></h4>

                </div>
                <div class="actionBtns">
                    <div class="left">
                        <img src="/public/image/heart.png" class="heart" onclick="likeBtn()">
                        <img src="/public/image/comment.png">
                        <img src="/public/image/share.png" onclick="goPost()">
                    </div>
                    <div class="right">
                        <img src="/public/image/bookmark.png">
                    </div>
                </div>

                <h4 class="message"><b><%=detailData[0].write_name%></b>&nbsp;&nbsp;&nbsp;<span>#StudyWITH</span>&nbsp;&nbsp;<span>#스터디위드</span>&nbsp;&nbsp;<span>#스윗</span>&nbsp;&nbsp;<span>#함께해요😋</span></h4>

                <div id="commentBox">
                <div id="commentHere">
                    <% for (i=0; i<detailData.length; i++) { %>
                    <div class="comment-section" id="<%=detailData[i].reply_id%>">
                        <input type="hidden" class="hidden_replyId" value="<%=detailData[i].reply_id%>">
                        <span id="replayName"><%=replynames[i]%></span>
                        <div class="msg-box" id="replyCont"><%=detailData[i].reply_contents%></div>
                        <button type="button" class="delete">x</button>
                    </div>
                    <% } %>
                </div>
                </div>
            
            </form>

            <form id="comment_info">
                <div class="addComments">
                    <div class="userImg">
                        <img src="/public/image/cute.png" >
                    </div>
                    <input type="hidden" name="studymem_name" value="<%=currentUser%>" readonly>
                    <input type="hidden" name="studymem_lounge_id" value="<%=detailData[0].real_lounge%>" readonly>
                    <h3><%=currentUser%><br><input type="text" class="text" placeholder="댓글을 남겨주세요" name="studymem_comment" /></h3>
                    <div><button type="button" onclick="enterComment()" class="enterImg" ></button></div>
                </div>
        </div>

            <script>
                function likeBtn() {
                    let heart = document.querySelector('.heart')
                    if (heart.src.match("/public/image/heart.png")){
                        heart.src = "/public/image/heart_red.png";
                    }
                    else {
                        heart.src = "/public/image/heart.png";
                    }
                }
            </script>

            </form>

        
    </div>

    

    <script>

    // 댓글 등록
    function enterComment() {
            var comments = document.getElementById('comment_info');
            
            axios({
                method:'post',
                url : 'http://localhost:8000/feed/board/detail',
                data : {
                    reply_id : comments.studymem_name.value,
                    reply_contents : comments.studymem_comment.value,
                    lounge_id : comments.studymem_lounge_id.value,
                }
            })
            .then((req) => {return req.data})
            .then((data) => {
                var html = "";
                
                    html = "<div class= 'comment-section' id= " + data.result.reply_id + ">"
                            + "<input type = 'hidden' class='hidden_replyId' value= " + data.result.reply_id +">"
                            + "<span id= 'replayName'>" + data.replyname[0].user_name + "</span>"
                            + "<div class= 'msg-box' id= 'replyCont' >" + data.result.reply_contents + "</div>"
                            + "<button type='button' class='delete'>x</button>"
                            + "</div>";

                $("#commentBox").append(html);
                

                // document.getElementById('studymem_comment').value = "";

                
            })
        }

/*여기부터*/
    
    //댓글삭제
        function deleteComment(id,target) {
            var User_form = document.getElementById("comment_info");
            var UserNow = User_form.studymem_name.value;
            var UserId = $(target).parent('td').siblings('.hidden_replyId').text();
            console.log(id);

            if (UserId == UserNow) {
/*여기까지*/

    // 댓글 삭제
    var dCs= document.querySelectorAll('.delete');

        for (const dC of dCs) {

            dC.addEventListener('click',function(event) {
                var target = event.currentTarget;
                console.log(target);  //버튼 그 자체

                var replyId = $(target).parent('button').siblings('.hidden_replyId').value();
                console.log(replyId);
/*여기부터*/
                axios({
                    method:'post',
                    url:'http://localhost:8000/feed/board/detail/remove',
                    data: {
                        reply_id : id,
                    }
                })
                .then((req) => {return req.data;})
                .then((data) => {
                        // console.log(UserId);
                        // console.log(UserNow);
                    if (data == true) {
/*여기부터*/
                            $(target).parent('td').parent('tr').remove();
                            console.log('삭제성공!');

                        } 
                    else {
                            console.log('아이디 확인');
                        }
                    })
                }
            }
        

    //
        function deletePost(id,target) {
            var User_form = document.getElementById("comment_info");
            var UserNow = User_form.studymem_name.value; //현재 아이디
            // var UserName = User_form.studymem_user_name.value;  //아이디
            console.log(UserNow);
            // console.log(UserName);

            var PostLoungeId = $(target).parent('td').parent('tr').siblings('.lounge_total').children('td:first').text();
            var PostName = $(target).parent('td').parent('tr').siblings('.lounge_total').children('td:nth-child(2)').text();
            console.log(PostLoungeId); //라운지아이디
            console.log(PostName); //작성자네임?

            if ( PostName == UserNow) {
/*여기부터*/
                    $(target).parent('button').parent('div').remove();
                    console.log('삭제완료!');
                    }
                })
            })
        }



    //게시글 삭제
        var dPs= document.querySelectorAll('.deletePosting');

        for (const dP of dPs) {

            dP.addEventListener('click',function(event) {
                var target = event.currentTarget;
                var loungeId = $(target).parent('td').parent('tr').siblings('.lounge_total').children('td:first').text();
                console.log(loungeId);

/*여기부터*/
                axios({
                    method:'post',
                    url:'http://localhost:8000/feed/board/remove',
                    data: {
                        lounge_id : PostLoungeId,
                    }
                })
                .then((req) => {return req.data;})
                .then((data) => {
                        
                    if (data == true) {
                            $(target).parent('td').parent('tr').parent('tbody').remove();
                            alert('삭세 성공!');
                            document.location.href='http://localhost:8000/feed/board?study_id=<%=detailData[0].study_id%>';

                        } 
                    
                    })
                } else {
                            console.log('작성자가 아닙니다!');
                        }
            }








    // 목록 클릭 시 라운지로 돌아가기
    function backToLounge() {
            // document.location.href=`http://localhost:8000/feed/board?study_id=${study_id}`;
            document.location.href='http://localhost:8000/feed/board?study_id=<%=detailData[0].study_id%>';
        }

    //홈버튼
        function goHome() {
            document.location.href="http://localhost:8000/swith";
            }

        function goDetail() {
            document.location.href="http://localhost:8000/feed/board/write";
            }
    </script>

</body>
</html>